<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta content = "text/html;charset=utf-8">
    <meta http-equiv="x-ua-compatible" content="IE=edge">
    <meta name = "google-signin-client_id" content = "902483045322-ame66rsf4mu0cklmgavrh4d2u5dr57f9.apps.googleusercontent.com">

    <link rel="stylesheet" 
	href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.5/css/bootstrap.min.css" 
	integrity="sha384-AysaV+vQoT3kOAXZkl02PThvDr8HYKPZhNT5h/CXfBThSRXQ6jW5DO2ekP5ViFdi" 
	crossorigin="anonymous">

    <link rel = "stylesheet" 
	type = "text/css" 
	href = "css.css">

    <script src="http://www.w3schools.com/lib/w3data.js"></script>
    <script src = "https://apis.google.com/js/api.js"></script>
    <script src ="https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js"></script>
    <script async defer 
	type = "text/javascript" 
	src = "https://maps.googleapis.com/maps/api/js?key=AIzaSyB_O-DWv_X7RsiS9oQuqAeNCrwpJPcgrDM&libraries=places&callback=initMap">
    </script>

  </head>

  <body>

	<div w3-include-html="overhead.html"></div>
	<script>
	w3IncludeHTML();
	</script>

 <div class="container">
   <h1><center>Welcome to your personal map handler.</center></h1>
    <center>
     <form class="form-inline">
      <div class="form-group">
       <input type="text" id ="mapname" name="mapname" class="form-control form-control-lg" placeholder="Map name">
      </div>
      <div class="form-group">
       <input type="text" id ="y" name="y" class="form-control form-control-lg" placeholder="Latitude (y)">
      </div>
      <div class="form-group">
       <input type="text" id="x" name="x"class="form-control form-control-lg" placeholder="Longitude (x)">
      </div>
      <br/>
      <input type="button" name="submit" value="Action" onclick="clickMe();" class="btn btn-success btn-lg">
      <input type="button" name="submit" value="History" onclick="history();" class="btn btn-success btn-lg">
     </form>
    </center>

	<!-- input id="pac-input" class="controls" placeholder="Search box" -->
		<div class="map" id="map">
		<center>

		<script>
	function history(){
		var one = document.getElementById("mapname").value;
		var request = new XMLHttpRequest();
		request.onreadystatechange = function(){
			if(request.readyState == 4 && request.status == 200){
				document.getElementById("history").innerHTML = request.responseText;
			}
		}
		if(one){
			request.open("GET", "/api/getMapHistory/"+one, true);
			request.send(null);
		}else{
			request.open("GET", "/api/getAllMapHistory/", true);
			request.send(null);
		}
	}

        function clickMe(){

               	var one = document.getElementById("mapname").value;
		var two = document.getElementById("x").value;
		var three = document.getElementById("y").value;

		var request = new XMLHttpRequest();
		request.onreadystatechange = function(){
			if(request.readyState == 4 && request.status == 200){
				var response = request.responseText;
				updateMap(response);
        		}
		}

		if(one && two && three){
			request.open("POST","/api/insertMap/"+one+"/"+two+"/"+three, true);
			request.send(null);
		}else if(one && !two && !three){
			request.open("GET","/api/getMap/"+one, true);
			request.send(null);
		}else{
			request.open("GET","/api/getAll", true);
			request.send(null);
		}
	}
	
	function updateMap(response){

		var array = new Array();
		array = JSON.parse(response);

//	-	response = response.replace(/"/g,"");
//		response = response.replace(/},{/g,"}{");
//		response = response.replace(/}{/g,"} {");		
//		response = response.split(" ");

		var object = {};
		var locations = new Array();
		array.forEach(function(arr){
			var tup = arr.split(",");
			var lat = parseFloat(tup[0]);
			var lng = parseFloat(tup[1]);
			locations.push({
				lat: lat,
				lng: lng
			});
		});
		var map = new google.maps.Map(document.getElementById("map"), {
        		zoom: 2,
        		center: {lat: 0.0, lng: 0.0}
        	});
	/*
		// SEARCH BOX
		var input = document.getElementById("pac-inputt");
		if(document.getElementById("pac-inputt") == null){
			console.log("failed pac-inputt");
		}
                var searchBox = new google.maps.places.SearchBox(input);
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

                map.addListener('bounds_changed', function(){
                        searchBox.setBounds(map.getBounds());
                });
	
	//	var markers = [];
                searchBox.addListener('places_changed', function(){
                        var places = searchBox.getPlaces();
                
		        if(places.length == 0){
                                return;
                        }

                        locations.forEach(function(marker){
                        	marker.setMap(null);
                        });
			locations = [];

                        var bounds = new google.maps.LatLngBounds();
                        places.forEach(function (place){
                                if(!place.geometry){
                                        console.log("Returned place contains no geometry");
                                        return;
                                }
                                var icon = {
                                        url: place.icon,
                                        size: new google.maps.Size(71,71),
                                        origin: new google.maps.Point(0,0),
                                        anchor: new google.maps.Point(17, 34),
                                        scaledSize: new google.maps.Size(25,25)
                                };

                                locations.push(new google.maps.Marker({
                                        map: map,
                                        icon: icon,
                                        title: place.name,
                                        position: place.geometry.location
                                }));

                                if(place.geometry.viewport){
                                        bounds.union(place.geometry.viewport);
                                }else{
                                        bounds.extend(place.geometry.location);
                                }
                        });
                        map.fitBounds(bounds);
                });
	*/
		var infowindow = new google.maps.InfoWindow();

		google.maps.event.addListener(map, 'click', function(e){
			var marker = new google.maps.Marker({
				position: e.latLng,
				map: map
			});
			infowindow.setContent(e.latLng.toString());
			infowindow.open(map, marker);

			marker.addListener('click', function(e){
				infowindow.setContent(e.latLng.toString()); // (y,x)
				infowindow.open(map, marker);
			});
		});

		var labels = 'ABCDEFGHIJKLMNOPQRSTUVXYÅÄÖ';

		var markers = locations.map(function(location, i){
			var marker = new google.maps.Marker({
				position: location,
				label: labels[ i % labels.length],
				title: 'click'
			});
			marker.addListener('click', function(e){
				infowindow.setContent(e.latLng.toString());
				infowindow.open(map, marker);
			});
			return marker;
		});

	        var markerCluster = new MarkerClusterer(map, markers,
{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
	}	
	    
	function initMap() {
		console.log("initMap()");
	
		var locations = [];
	
		var map = new google.maps.Map(document.getElementById("map"), {
        		zoom: 3,
	        	center: {lat: 0.0, lng: 0.0}
	        });
	/*
		var input = document.getElementById("pac-input");
                var searchBox = new google.maps.places.SearchBox(input);
                map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

		map.addListener('bounds_changed', function(){
			searchBox.setBounds(map.getBounds());
		});
		
		searchBox.addListener('places_changed', function(){
			var places = searchBox.getPlaces();
			if(places.length == 0){
				return;
			}
			
			locations.forEach(function(marker){
				marker.setMap(null);
			});
			
			locations = [];

			var bounds = new google.maps.LatLngBounds();
			places.forEach(function (place){
				if(!place.geometry){
					console.log("Returned place contains no geometry");
					return;
				}
				var icon = {
					url: place.icon,
					size: new google.maps.Size(71,71),
					origin: new google.maps.Point(0,0),
					anchor: new google.maps.Point(17, 34),
					scaledSize: new google.maps.Size(25,25)
				};

				locations.push(new google.maps.Marker({
					map: map,
					icon: icon,
					title: place.name,
					position: place.geometry.location
				}));

				if(place.geometry.viewport){
					bounds.union(place.geometry.viewport);
				}else{
					bounds.extend(place.geometry.location);
				}
			});
			map.fitBounds(bounds);
		});
	*/
	 	var infowindow = new google.maps.InfoWindow();

                google.maps.event.addListener(map, 'click', function(e){
                        var marker = new google.maps.Marker({
                                position: e.latLng,
                                map: map
                        });
                        infowindow.setContent(e.latLng.toString());
                        infowindow.open(map, marker);

                        marker.addListener('click', function(e){
                                infowindow.setContent(e.latLng.toString());
                                infowindow.open(map, marker);
                        });
                });

                var labels = 'ABCDEFGHIJKLMNOPQRSTUVXYÅÄÖ';

                var markers = locations.map(function(location, i){
                        var marker = new google.maps.Marker({
                                position: location,
                                label: labels[ i % labels.length],
                                title: 'click'
                        });
                        marker.addListener('click', function(e){
                                infowindow.setContent(e.latLng.toString());
                                infowindow.open(map, marker);
                        });
       			return marker;
                });
             var markerCluster = new MarkerClusterer(map, markers,{imagePath: 'https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/m'});
   
	}
		
		</script>
	<!--	input id="pac-inputt" class="controls" placeholder="Search Box after update" -->
		</div>

			<center>
			<style>
		div.scroll{
			background-color: #FFFFFF;
			width : 90%;
			height : 130px;
			overflow: scroll;
		}
			</style>

			<div class = "scroll">
				<p id="history"></p>
			</div>
			</center>
	</body>
</html>
